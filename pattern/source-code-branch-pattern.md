<!---
markmeta_author: 望哥
markmeta_date: 2020-05-13
markmeta_title: Patterns for Managing Source Code Branches
markmeta_categories: pattern
markmeta_tags: pattern, branch
-->

# 代码分支管理模式

> 本文提取 https://martinfowler.com/articles/branching-patterns.html 文章中总结性内容，作为知识梳理学习。


## 1. 基础模式

- 源码分支: 拷贝一份源码并在其上做变更；
- 主线分支: 一个单一、共享的分支, 该分支代表了当前产品的状态
- 健康分支: 对每一个提交都进行自动化检查，包括编译、测试等，确保这个分支没有问题；

## 2. 集成模式

- 主线集成: 开发人员拉取主线分支修改，如果改动没有问题，合并回主线分支；
- 特性分支: 在一个分支上开发所有特性功能，完成后再集成到主线分支；

集成频率：
- 低频：较长时间进行一次；合并代码量大； 冲突多； 冲突解决难度大； 问题暴露延迟； 易产生集成焦虑；
- 高频：频繁进行； 合并代码量小； 冲突小； 冲突解决难度小；及时暴露问题； 集成意愿强 ； 

持续集成: 当提交代码（通常小于一天工作量）没有问题则尽快进行主线集成

特性分支和持续集成对比：
- 特性分支： 
	1. 一个特性的所有代码能够通过一个单元测试评估其质量
	2. 只有特性功能完成后才添加到产品代码中；
	3. 低频率合并
- 持续集成：
	1. 高频率集成
	2. 减少发现冲突的时间
	3. 小量的合并
	4. 鼓励重构
	5. 承诺健康分支（自己验证测试过的代码）
	6. 支持更好的软件发布表现

特性分支在开源软件中表现不错，主要是开源软件的特性决定的：
1. 一个人或一个小组织作为代码维护者；
2. 大量其他开发者为贡献者；
3. 维护者一般不了解贡献者，无法了解其贡献代码的质量，能够投入都少时间，以及效率高低；

对于商业项目，公司项目leader了解项目成员，了解他们的能力、习惯，也能够保证开发时间；

代码评审： 
- 合并到主线分支的每一个提交被接受之前都是经过评审的；
- 结对编程包含持续评审的过程；
- 评审可以及时发现问题，及时重构；
- 对于开源项目和特性分支模式很有效；
- 一定程度上会影响持续集成的效率，因为要解决了评审问题才能提交集成；
- 可能建立起不信任的文化，打击积极性；
- 是否适用要具体看团队结构、文化，也经常由leader决策；


集成摩擦：
- 如果集成需要投入额外的工作、精力、时间，开发人员可能就会尽量减少集成。
- 这些摩擦影响了集成效率，可以通过一些方法减少摩擦，比如自动化流程、开发培训、部署流水线、线上测试等。
- 事后（或周期性）代码评审往往很有效，不会影响团队信任，也可以发挥代码评审的作用；
- 使用什么开发模式及方法，一个很重要的考量是团队信任程度；


模块化的重要性:
- 减少集成冲突
- 需要不断重构
- 有助于持续集成
- 困难但值得投入，最佳实践，设计模式等
- 从糟糕的合并中学习，吸取经验教训
- 不断询问问题： 如何改进模块化？如何提高代码健康度？

## 3. 从主线分支到生产发布

需要保持主线分支的健康，并通过CD工具（部署流水线）将 tag 版本发布到线上。
不适用持续发布的团队则需要其他方法。

**发布分支**： 只接收使产品趋于稳定版本的提交（Fix）， 有两种方式：
1. Fix在发布分支上修改，再合并到主线分支；
2. Fix在主线分支上修改，再 cherry-pick 合并发布分支；

但随着主线分支修改越多，合并就越来越难。
对于只有单一版本产品的项目，可以直接在主线分支上修改打tag，主线分支即发布分支。
对于多版本项目，同时存在多个发布分支，则会更麻烦，鼓励客户升级到最新版本减少分支方可减少合并工作量。
有时候发布分支需要评审委员会评审后方可发布，可能影响效率和团队信任，应尽量去除。


**稳定分支**: 记录代码达到某一稳定性级别的最新版本。可以从发布分支合并过来。方便开发或OA追踪稳定版本。

**长久发布分支**: 有的单一版本项目，只保留一个分布分支，当要发布新版则一次性合并主线分支并打新的tag版本；

**环境分支**: 通过代码提交配置产品运行环境。 但建议环境配置和代码分开，一次集成多环境部署。

